# HTTP

## Введение

Аббревиатура `HTTP` расшифровывается как `HyperText Transfer Protocol`, «протокол передачи гипертекста». `HTTP` является протоколом прикладного уровня по модели OSI (верхнего, 7-го).

`HTTP` — широко распространённый протокол передачи данных, изначально предназначенный для передачи гипертекстовых документов(частный случай - `HTML`), в настоящий момент используется для передачи произвольных данных.

Протокол `HTTP` предполагает использование клиент-серверной структуры передачи данных. Клиентское приложение формирует запрос и отправляет его на сервер, после чего сервер обрабатывает данный запрос, формирует ответ и передаёт его обратно клиенту. После чего клиент может продолжить слать запросы, которые будут обработаны аналогичным образом.

Какие задачи решает `HTTP`?

* Структура данных, передаваемых по сети.
  
  Данные передаются по `TCP` сплошным потоком байт, клиент и сервер, которые взаимодействуют по `TCP` должны каким-то образом договориться когда можно считать, что запрос закончен, когда можно считать, что ответ получен? Нужна внутренняя структура для данных.

* Передача мета-информации о документе.

    MIME-type(Content-type), размер документа и т.д.

* Авторизация.
    
    Передаваемые документы могут быть как публичными, так и приватными. Для обеспечения приватности нужна проверка прав доступа, авторизация.

* Поддержка сессий.
* Кеширование документов.
* Согласование содержимого.
  
  Клиент и сервер могут договориться в каком виде передавать документ, например, сжимать его и по какому протоколу это делать.
* Управление соединением.
    Протокол `TCP` не предусматривает управления, кроме как закрытия соединения. Протокол `HTTP` позволяет более гибко управлять соединением, в частности, закрывать его или оставлять открытым для последующих запросов.

Ключевые особенности:

* Работает поверх `TCP/TLS`.
* Протокол `HTTP` работает по принципу запрос-ответ.
* Это `stateless` протокол, он не хранит состояние о соединении.
* Является текстовым протоколом, данные передаются в виде `plain` текста, с разделителем "\r\n".
* Расширяемый протокол. Можно вводить дополнительные заголовки.

Задача, которую необходимо было решить в первую очередь - это указать Content-type документа и его длину.

Помимо всего вышеперечисленного, в `HTTP 1.1` были введены:

* Виртуальные хосты
  
  На одном IP и порту несколько DNS имен.

* Persistent-Connection
    
    Connection: Keep-Alive по умолчанию.

* Chunked transfer encoding
  
    Позволяет отправлять ответ не зная его полного размера и не буферизуя его на стороне сервера.
    Отправляем по кусочкам.

* Range request
  
  Запрос только части ресурса. Например, позволяет в несколько потоков скачать ресурс.

В `HTTP 1.1` соединение будет закрыто, если:

* Сервер или клиент использует версию `HTTP` младше 1.1
* Сервер или клиент передал заголовок Connection: close
* По истечению таймаута

Иначе соединение остается открытым для последующих запросов.

Сейчас мир постепенно переходит к использованию протокола `HTTP 2.0`.

## Структура

Каждое `HTTP`-сообщение состоит из трёх частей, которые передаются в указанном порядке:

* Стартовая строка - определяет тип сообщения;

    Запрос представляется в виде: `Метод URI HTTP/Версия`.

        Метод - тип запроса, одно слово заглавными буквами. Список методов для версии 1.1 представлен ниже.
        
        URI определяет путь к запрашиваемому документу.
        
        Версия - пара разделённых точкой цифр. Например: 1.1.

        Пример: GET /wiki/HTTP HTTP/1.1

    Ответ представляется в виде: `HTTP/Версия КодСостояния Пояснение`.

        Версия - пара разделённых точкой цифр, как в запросе;
        
        Код состояния - три цифры. По коду состояния определяется дальнейшее содержимое сообщения и поведение клиента;
        
        Пояснение - текстовое короткое пояснение к коду ответа для пользователя. Никак не влияет на сообщение и является необязательным.

        Пример: HTTP/1.1 200 OK

* Заголовки - характеризуют тело сообщения, параметры передачи и прочие сведения;
* Тело сообщения - непосредственно данные сообщения. Обязательно должно отделяться от заголовков пустой строкой.

Тело сообщения может отсутствовать, в то время как стартовая строка и заголовок являются обязательными элементами.

Для версии протокола `1.1` сообщение запроса обязательно должно содержать заголовок `Host`. Почему?

Преобразование доменного имени в `IP`-адрес осуществляется на стороне клиента, и когда открывается `TCP`-соединение, то удалённый сервер не обладает никакой информацией о том, какой именно адрес использовался для соединения. Благодаря `virtual hosts`, это может быть и habrahabr.ru, и m.habrahabr.ru, ответ может разниться для каждого. Однако фактически сетевое соединение во всех случаях открывается с узлом по `IP`-адресу, и даже если первоначально при открытии соединения был задан не этот `IP`-адрес, а какое-либо доменное имя, то сервер об этом никак не информируется - и именно поэтому этот адрес необходимо передать в заголовке `Host`. Чтобы сервер знал как был сформирован запрос.

## HTTP методы

Метод представляет собой последовательность из любых символов, кроме управляющих и разделителей, определяет операцию, которую нужно осуществить с указанным ресурсом.

`HTTP` методы:

* `GET` - получение документа.

    Согласно стандарту `HTTP`, запросы типа `GET` считаются [идемпотентными](https://ru.wikipedia.org/wiki/%D0%98%D0%B4%D0%B5%D0%BC%D0%BF%D0%BE%D1%82%D0%B5%D0%BD%D1%82%D0%BD%D0%BE%D1%81%D1%82%D1%8C).

    Кроме обычного метода `GET`, различают ещё

    * Условный `GET` — содержит заголовки If-Modified-Since, If-Match, If-Range и подобные;
    * Частичный `GET` — содержит в запросе Range.

* `HEAD` - получение только заголовков и статуса ответа.
  
    Для проверки наличия документа, например, поисковыми ботами.

* `POST` - отправка данных на сервер.

    Применяется для передачи пользовательских данных заданному ресурсу. Данные могут быть произвольными.
    В отличие от метода `GET`, метод `POST` не считается идемпотентным.

* `PUT` - отправка документа на сервер.
  
  Отправка данных, но отправка документа целиком. Обычно отключен в целях безопасности.
  Фундаментальное различие методов `POST` и `PUT` заключается в понимании предназначений `URI` ресурсов. Метод `POST` предполагает, что по указанному `URI` будет производиться обработка передаваемого клиентом содержимого. Используя `PUT`, клиент предполагает, что загружаемое содержимое соответствует находящемуся по данному `URI` ресурсу.

  Сообщения ответов сервера на метод `PUT` не кэшируются.

* `DELETE` - удаление документа.
  
  Обычно отключен в целях безопасности.
* CONNECT, TRACE, OPTIONS

    Для получения информации о веб-сервере.


## HTTP коды ответа

`HTTP` коды ответа:

* 1xx - информационные.

    Для координации действий клиента и веб-сервера.

* 2xx - упешное выполнение
  
  Примеры: 
   * 200 OK - запрос успешно выполнен, в теле ответа будет документ для клиента.
   * 204 No Content - запрос успешно выполнен, но документ пуст.


* 3xx - перенаправление
  
    Документ может быть получен с другого `URL`, существуют другие версии документа и т.д.

    Примеры:
    * 301 Moved Permanently - документ сменил URL. Может кешироваться на стороне браузера.
    * 302 Found - повторить запрос по другому URL. Не кешируется.
    * 304 Not Modified - документ не изменился, использовать кеш.

* 4xx - ошибка на стороне клиента
  
  Запрос осуществить не удалось и проблема у клиента.
  
  Примеры:
    * 400 Bad Request - неправильный синтаксис запроса.
    * 401 Unauthorized - требуется авторизация.
    * 403 Forbidden - нет доступа.
    * 404 Not Found - документ не найден.
  
* 5xxx - ошибка на стороне сервера

  Примеры:
    * 500 Internal Server Error - неожиданная ошибка сервера.
    * 502 Bad Gateway - проксируемый сервер отвечает с ошибкой.
    * 504 Gateway Timeout - проксируемый сервер не отвечает.

## Заголовки HTTP запросов

### Общие

* Content-Type - MIME тип документа.
* Content-Length - длина сообщения.
* Content-Encoding - кодирование документа, например, gzip-сжатие.
* Transfer-Encoding - формат передачи, например, chunked - передача частями.
* Connection - управление соединением. В `HTTP 1.1` предполагается удержание соединения, если не передано `close`.

### Остальные

* Authorization - авторизация, логин/пароль.
* Cookie - передача состояниея(сессии) на сервер. Так как сервер не поддерживает постоянное соединение с пользователем и должен понимать, что за пользователь пришел, то используют информацию о сессии, передавая ее в заголовке Cookie.
* Refer - URL предыдущего документа, контекст запроса. Например, с какого сайта перешли на нашу страничку.
* User-Agent - описание web-слиента, версия браузера.
* If-Modified-Since - условный GET запрос.
* Accept:* - согласование содержимого. Договоренности какие документы браузер готов принять(сжатые, кодировка и т.д.).

### Пример

Как уже было сказано, для того, чтобы сформировать `HTTP`-запрос, необходимо составить стартовую строку, а также задать по крайней мере один заголовок — это заголовок Host, который является обязательным, и должен присутствовать в каждом запросе.

Запрос клиента:

```javascript
GET /wiki/страница HTTP/1.1
Host: ru.wikipedia.org
User-Agent: Mozilla/5.0 (X11; U; Linux i686; ru; rv:1.9b5) Gecko/2008050509 Firefox/3.0b5
Accept: text/html
Connection: close
(пустая строка)  
```

Стартовая строка:

```javascript
GET /wiki/страница HTTP/1.1
```

Здесь сообщается, что необходимо получить документ, используя протокол `HTTP` версии 1.1.
В заголовках предоставляется информация о клиенте и о том, что мы работаем с текстом, без сжатия. Соединение после ответа можно закрыть.

Ответ сервера:

```javascript
HTTP/1.1 200 OK
Date: Wed, 11 Feb 2009 11:20:59 GMT
Server: Apache
X-Powered-By: PHP/5.2.4-2ubuntu5wm1
Last-Modified: Wed, 11 Feb 2009 11:20:59 GMT
Content-Language: ru
Content-Type: text/html; charset=utf-8
Content-Length: 1234
Connection: close
(пустая строка)
(запрошенная страница в HTML)
```

В ответе говорится, что запрос выполнен успешно, в заголовках предоставляется информация о странице и ее содержании, длине, кодировке и сама страница.

## Полезные ссылки

1. [Web-технологии. Протокол HTTP | Технострим][(https://habr.com/ru/post/113145/](https://www.youtube.com/watch?v=HFt7Lm7hv1E))
2. [HTTP Wikipedia](https://ru.wikipedia.org/wiki/HTTP)
3. [HTTP протокол - Иван Бибилов](https://www.youtube.com/watch?v=yUHlrabtEaU)
4. [HTTP и HTTPS - Вячеслав Бирюков](https://www.youtube.com/watch?v=WNVcwW7mC34&t=1550s)
5. [Простым языком об HTTP](https://habr.com/ru/post/215117/)
6. [Что надо знать о HTTP/2](https://www.youtube.com/watch?v=4yyhqMh9FcY)